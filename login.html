<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B.Y PRO Accounts - Login</title>
    <link rel="icon" type="image/png" href="https://bypro.kesug.com/B.Y%20PRO.png">
    <link rel="shortcut icon" href="https://bypro.kesug.com/B.Y%20PRO.png">
    <link rel="apple-touch-icon" href="https://bypro.kesug.com/B.Y%20PRO.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ŸÜŸÅÿ≥ ÿßŸÑŸÄ CSS ÿßŸÑÿ≥ÿßÿ®ŸÇ */
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-wifi"></i> <span id="connectionText">Connected</span>
    </div>

    <div class="login-container">
        <div class="logo">
            <h1><i class="fas fa-user-shield"></i> B.Y PRO Accounts</h1>
            <p>Secure Login System</p>
        </div>

        <!-- Logged In Info -->
        <div class="logged-in-info" id="loggedInInfo">
            <div class="user-avatar" id="userAvatar">
                <i class="fas fa-user-check"></i>
            </div>
            <h3>Welcome back, <span id="userName">User</span>!</h3>
            <div class="success-message">
                <i class="fas fa-check-circle"></i>
                <span>Login successful! Closing in 3 seconds...</span>
            </div>
            <button class="login-btn" onclick="forceClose()" style="margin-top: 20px; background: var(--primary-color);">
                <i class="fas fa-times"></i> Close Now
            </button>
        </div>

        <!-- Login Methods -->
        <div id="loginSection">
            <div class="login-methods">
                <button class="method-btn active" data-method="qr">
                    <i class="fas fa-qrcode"></i> QR Code
                </button>
                <button class="method-btn" data-method="manual">
                    <i class="fas fa-keyboard"></i> Manual Login
                </button>
            </div>

            <!-- QR Code Login -->
            <div class="login-form active" id="qrForm">
                <div class="qr-scanner">
                    <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem;">
                        Upload QR code image to login
                    </p>
                    
                    <div class="file-upload">
                        <input type="file" id="qr-file" class="file-input" accept="image/*">
                        <label for="qr-file" class="file-label">
                            <i class="fas fa-upload"></i> Upload QR Code Image
                        </label>
                    </div>
                </div>
            </div>

            <!-- Manual Login -->
            <div class="login-form" id="manualForm">
                <div class="form-group">
                    <label for="userIdInput"><i class="fas fa-id-card"></i> Account ID</label>
                    <input type="text" id="userIdInput" placeholder="Enter your account ID" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="passwordInput"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="passwordInput" placeholder="Enter your password" autocomplete="current-password">
                </div>

                <!-- Status Message -->
                <div id="statusMessage" class="status-message"></div>

                <!-- Login Button -->
                <button class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </div>

            <!-- Signup Section -->
            <div class="signup-section">
                <p class="signup-text">Don't have an account?</p>
                <a href="https://yacine2007.github.io/secure-auth-app/signup.html" class="signup-btn">
                    <i class="fas fa-user-plus"></i> Sign Up Now
                </a>
            </div>
        </div>
    </div>

    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
        // ========== BYPRO LOGIN SYSTEM - ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖŸàÿ≠ÿØ ==========
        
        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const loggedInInfo = document.getElementById('loggedInInfo');
        const methodBtns = document.querySelectorAll('.method-btn');
        const qrForm = document.getElementById('qrForm');
        const manualForm = document.getElementById('manualForm');
        const loginBtn = document.getElementById('loginBtn');
        const statusMessage = document.getElementById('statusMessage');
        const qrFileInput = document.getElementById('qr-file');
        const userIdInput = document.getElementById('userIdInput');
        const passwordInput = document.getElementById('passwordInput');
        const userNameSpan = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');

        // Server Configuration
        const API_BASE = 'https://b-y-pro-acounts-login.onrender.com';

        // Variables
        let currentMethod = 'qr';
        let isOnline = false;
        let currentUser = null;

        // ========== INITIALIZE ==========
        function init() {
            console.log('üöÄ BYPRO Login initializing...');
            
            setupEventListeners();
            setupMessageListener();
            checkConnection();
            
            // Focus on ID field if in manual mode
            if (currentMethod === 'manual') {
                setTimeout(() => userIdInput.focus(), 300);
            }
        }

        // ========== SETUP EVENT LISTENERS ==========
        function setupEventListeners() {
            // Switch between login methods
            methodBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    methodBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMethod = btn.dataset.method;
                    
                    qrForm.classList.remove('active');
                    manualForm.classList.remove('active');
                    
                    if (currentMethod === 'qr') {
                        qrForm.classList.add('active');
                    } else {
                        manualForm.classList.add('active');
                        setTimeout(() => userIdInput.focus(), 300);
                    }
                });
            });

            // QR Code upload
            qrFileInput.addEventListener('change', handleQRUpload);

            // Manual login
            loginBtn.addEventListener('click', handleManualLogin);

            // Enter key in manual form
            [userIdInput, passwordInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loginBtn.click();
                    }
                });
            });

            // Input validation
            userIdInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^a-zA-Z0-9_-]/g, '');
            });
        }

        // ========== MESSAGE LISTENER ==========
        function setupMessageListener() {
            window.addEventListener('message', (event) => {
                console.log('üì® Message received:', event.data);
                
                // Handle auth requests from parent
                if (event.data && event.data.type === 'AUTHSYNC_AUTH_REQUEST') {
                    console.log('üîê Auth request from parent');
                    // ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿØ ŸáŸÜÿß ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
                }
                
                // Handle other messages
                if (event.data && event.data.type === 'BYPRO_LOGOUT') {
                    console.log('üö™ Logout requested');
                    // ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
                }
            });
        }

        // ========== HANDLE QR UPLOAD ==========
        function handleQRUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                showStatus('Image size too large. Please select a smaller image.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    scanQRCode(img);
                };
                img.onerror = () => {
                    showStatus('Error loading image', 'error');
                };
                img.src = e.target.result;
            };
            reader.onerror = () => {
                showStatus('Error reading file', 'error');
            };
            reader.readAsDataURL(file);
        }

        // ========== SCAN QR CODE ==========
        function scanQRCode(img) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            context.drawImage(img, 0, 0);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, canvas.height);
            
            if (code) {
                processQRCode(code.data);
            } else {
                showStatus('No QR code found in the image', 'error');
            }
        }

        // ========== PROCESS QR CODE ==========
        function processQRCode(data) {
            console.log('üì± QR Code detected:', data);
            
            if (data.startsWith('BYPRO:')) {
                const parts = data.split(':');
                if (parts.length === 3) {
                    const id = parts[1];
                    const password = parts[2];
                    
                    if (id && password) {
                        showStatus('QR code detected! Verifying...', 'success');
                        verifyLogin(id, password);
                    } else {
                        showStatus('Invalid QR code format', 'error');
                    }
                } else {
                    showStatus('Invalid QR code format. Expected: BYPRO:ID:PASSWORD', 'error');
                }
            } else {
                showStatus('This is not a B.Y PRO QR code', 'error');
            }
        }

        // ========== HANDLE MANUAL LOGIN ==========
        function handleManualLogin() {
            const id = userIdInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!id) {
                showStatus('Please enter your account ID', 'error');
                userIdInput.focus();
                return;
            }
            
            if (!password) {
                showStatus('Please enter your password', 'error');
                passwordInput.focus();
                return;
            }
            
            verifyLogin(id, password);
        }

        // ========== VERIFY LOGIN ==========
        async function verifyLogin(id, password) {
            console.log('üîê Verifying login:', { id });
            
            // Show loading state
            setLoading(true);

            try {
                // Make API request
                const url = `${API_BASE}/api/verify-account?id=${encodeURIComponent(id)}&password=${encodeURIComponent(password)}`;
                console.log('üåê Making request to:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors'
                });

                console.log('üì• Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                const result = await response.json();
                console.log('üì¶ Response data:', result);

                if (result.success) {
                    // Get additional account data
                    const accountsResponse = await fetch(`${API_BASE}/api/debug/accounts`);
                    const accountsData = await accountsResponse.json();
                    
                    let userImage = '';
                    let userName = '';
                    let userEmail = '';
                    
                    if (accountsData.success) {
                        const account = accountsData.accounts.find(acc => acc.id === id);
                        userImage = account?.image || '';
                        userName = account?.name || '';
                        userEmail = account?.email || '';
                    }

                    // Create user object
                    const authString = `BYPRO:${id}:${password}`;
                    const userData = {
                        id: id,
                        username: userName || `Developer_${id}`,
                        password: password,
                        authString: authString,
                        name: userName || `Developer ${id}`,
                        email: userEmail || '',
                        image: userImage || '',
                        loginTime: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        source: 'bypro_login',
                        uid: id,
                        developerId: id,
                        developerName: userName || `Developer #${id}`,
                        developerEmail: userEmail || ''
                    };

                    console.log('üë§ User data created:', userData);
                    
                    // Save to localStorage
                    saveToLocalStorage(userData);
                    
                    // Send to parent
                    sendToParent(userData);
                    
                    // Show success
                    showLoginSuccess(userData);
                    
                } else {
                    showStatus(result.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('‚ùå Login error:', error);
                if (error.name === 'TypeError' || error.message.includes('Failed to fetch')) {
                    showStatus('Cannot connect to server. Please check your internet connection.', 'error');
                    updateConnectionStatus(false);
                } else {
                    showStatus('Login error: ' + error.message, 'error');
                }
            } finally {
                setLoading(false);
            }
        }

        // ========== SAVE TO LOCALSTORAGE ==========
        function saveToLocalStorage(userData) {
            try {
                const authData = {
                    user: userData,
                    timestamp: Date.now(),
                    version: '2.0'
                };

                // Save primary data
                localStorage.setItem('bypro_auth_data', JSON.stringify(authData));
                console.log('üíæ Saved to bypro_auth_data');
                
                // Save backup data
                localStorage.setItem('bypro_user', JSON.stringify(userData));
                localStorage.setItem('bypro_status', JSON.stringify({
                    authenticated: true,
                    timestamp: Date.now()
                }));
                
                return true;
            } catch (error) {
                console.error('‚ùå Error saving to localStorage:', error);
                return false;
            }
        }

        // ========== SEND TO PARENT ==========
        function sendToParent(userData) {
            if (window.parent !== window) {
                // Send primary message
                window.parent.postMessage({
                    type: 'BYPRO_AUTH_SUCCESS',
                    user: userData,
                    authString: userData.authString,
                    timestamp: Date.now()
                }, '*');
                
                console.log('üì® Sent BYPRO_AUTH_SUCCESS to parent');
                
                // Send backup message after delay
                setTimeout(() => {
                    window.parent.postMessage({
                        type: 'AUTHSYNC_AUTH_RESPONSE',
                        authenticated: true,
                        user: userData,
                        authString: userData.authString,
                        sessionId: generateSessionId(),
                        timestamp: Date.now()
                    }, '*');
                    
                    console.log('üì® Sent AUTHSYNC_AUTH_RESPONSE to parent');
                }, 100);
                
                // Send close message after 2 seconds
                setTimeout(() => {
                    window.parent.postMessage({
                        type: 'CLOSE_IFRAME',
                        reason: 'login_success',
                        timestamp: Date.now()
                    }, '*');
                    
                    console.log('üì® Sent CLOSE_IFRAME to parent');
                }, 2000);
            }
        }

        // ========== SHOW LOGIN SUCCESS ==========
        function showLoginSuccess(userData) {
            console.log('üéâ Login success!');
            
            // Update UI
            loginSection.style.display = 'none';
            loggedInInfo.style.display = 'block';
            userNameSpan.textContent = userData.name || `User ${userData.id}`;
            
            // Show avatar
            if (userData.image) {
                userAvatar.innerHTML = `<img src="${userData.image}?t=${Date.now()}" alt="User Avatar" onerror="handleImageError(this)">`;
            } else {
                userAvatar.innerHTML = '<i class="fas fa-user-check"></i>';
            }
            
            showStatus('Login successful! Closing in 3 seconds...', 'success');
            updateConnectionStatus(true);
            
            // Auto close after 3 seconds
            setTimeout(() => {
                forceClose();
            }, 3000);
        }

        // ========== UTILITY FUNCTIONS ==========
        function setLoading(isLoading) {
            if (currentMethod === 'qr') {
                const fileLabel = document.querySelector('.file-label');
                if (isLoading) {
                    fileLabel.innerHTML = '<div class="loading-spinner"></div> Verifying...';
                    fileLabel.style.opacity = '0.7';
                    fileLabel.style.cursor = 'not-allowed';
                } else {
                    fileLabel.innerHTML = '<i class="fas fa-upload"></i> Upload QR Code Image';
                    fileLabel.style.opacity = '1';
                    fileLabel.style.cursor = 'pointer';
                    qrFileInput.value = '';
                }
            } else {
                if (isLoading) {
                    loginBtn.disabled = true;
                    loginBtn.innerHTML = '<div class="loading-spinner"></div> Verifying...';
                } else {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                }
            }
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        function updateConnectionStatus(online) {
            isOnline = online;
            if (online) {
                connectionStatus.className = 'connection-status connection-online';
                connectionText.textContent = 'Connected';
                connectionStatus.style.display = 'block';
                setTimeout(() => {
                    connectionStatus.style.display = 'none';
                }, 3000);
            } else {
                connectionStatus.className = 'connection-status connection-offline';
                connectionText.textContent = 'Offline - Check Connection';
                connectionStatus.style.display = 'block';
            }
        }

        function handleImageError(img) {
            console.log('üñºÔ∏è Image loading error');
            const parent = img.parentElement;
            parent.innerHTML = '<i class="fas fa-user-check"></i>';
        }

        function generateSessionId() {
            return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                updateConnectionStatus(response.ok);
                return response.ok;
            } catch (error) {
                updateConnectionStatus(false);
                return false;
            }
        }

        function forceClose() {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'CLOSE_IFRAME',
                    reason: 'manual_close',
                    timestamp: Date.now()
                }, '*');
            }
        }

        // ========== GLOBAL FUNCTIONS ==========
        window.forceClose = forceClose;

        // ========== START ==========
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
